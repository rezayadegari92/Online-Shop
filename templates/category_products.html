<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><title>Category Products</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
  <button class="btn btn-link" onclick="history.back()">← Back</button>
  <h2 id="cat-name">Products</h2>
  <div id="plist"></div>
  <nav><ul id="pg" class="pagination"></ul></nav>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
  const token = localStorage.getItem('access_token');
  const cid = new URLSearchParams(location.search).get('id');
  const base = `/api/categories/${cid}/products/`;

  function load(pageUrl = base) {
    $.ajax({
      url: pageUrl, headers:{'Authorization':'Bearer '+token},
      success: render
    });
  }

  function render(d){
    $('#plist').empty();
    d.results.forEach(p=>{
      $('#plist').append(`
        <div><a href="product_detail.html?id=${p.id}">${p.name}</a> — $${p.final_price}</div>
      `);
    });
    const count = Math.ceil(d.count/10);
    $('#pg').empty();
    if (d.previous) $('#pg').append('<li class="page-item"><a class="page-link" href="#">Prev</a></li>');
    for(let i=1;i<=count;i++){
      $('#pg').append(`<li class="page-item${i===getPage(d)?' active':''}">
        <a class="page-link" href="#">${i}</a></li>`);
    }
    if(d.next) $('#pg').append('<li class="page-item"><a class="page-link" href="#">Next</a></li>');
  }

  function getPage(d){
    if(!d.previous&&!d.next) return 1;
    if(d.previous) return parseInt(new URL(d.previous).searchParams.get('page'))+1;
    return parseInt(new URL(d.next).searchParams.get('page'))-1;
  }

  $('#pg').on('click','.page-link',function(e){
    e.preventDefault();
    let txt = $(this).text(), url;
    const cur = getPage(currentData);
    if(txt==='Prev') url = base+'?page='+(cur-1);
    else if(txt==='Next') url = base+'?page='+(cur+1);
    else url = base+'?page='+txt;
    load(url);
  });

  load();
</script>
</body>
</html>
