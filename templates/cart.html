<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><title>Shopping Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>.cart-item{padding:15px;background:#fff;margin-bottom:10px;border-radius:6px;}</style>
</head>
<body>
<div class="container mt-4">
  <h2>Your Cart</h2>
  <div class="input-group mb-3 w-50">
    <input id="discount-code" class="form-control" placeholder="Discount code">
    <button id="apply-discount" class="btn btn-outline-primary">Apply</button>
  </div>
  <div id="cart-items"></div>
  <div class="d-flex justify-content-between">
    <h4>Total: $<span id="final-price">0.00</span></h4>
    <button id="checkout-btn" class="btn btn-success">Checkout</button>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
  const token = localStorage.getItem('access_token');
  const cartApi = '/api/cart/';
  const itemsApi = '/api/cart/items/';

  function loadCart(){
    $.ajax({
      url: cartApi, headers:{'Authorization':'Bearer '+token},
      success: renderCart
    });
  }

  function renderCart(data){
    $('#cart-items').empty();
    data.items.forEach(i=>{
      $('#cart-items').append(`
        <div class="cart-item d-flex justify-content-between align-items-center" data-id="${i.id}">
          <div>
            <strong>${i.product_name}</strong><br>
            Price: $${i.product_price}
          </div>
          <div>
            <button class="btn btn-sm btn-secondary dec">-</button>
            <span class="mx-2">${i.quantity}</span>
            <button class="btn btn-sm btn-secondary inc">+</button>
            <button class="btn btn-sm btn-danger del ms-2">Delete</button>
          </div>
        </div>`);
    });
    $('#final-price').text(data.final_price);
  }

  // inc/dec
  $(document).on('click','.inc,.dec',function(){
    const div=$(this).closest('.cart-item'),
          id=div.data('id'),
          qty=parseInt(div.find('span').text()) + ($(this).hasClass('inc')?1:-1);
    updateQty(id, Math.max(1, qty));
  });
  // delete
  $(document).on('click','.del',function(){
    const id = $(this).closest('.cart-item').data('id');
    $.ajax({ url: itemsApi+id+'/', method:'DELETE',
      headers:{'Authorization':'Bearer '+token},
      success:loadCart
    });
  });
  function updateQty(id,qty){
    $.ajax({
      url: itemsApi+id+'/', method:'PATCH', contentType:'application/json',
      headers:{'Authorization':'Bearer '+token},
      data: JSON.stringify({quantity:qty}),
      success:loadCart
    });
  }

  // apply discount
  $('#apply-discount').click(function(){
    const code = $('#discount-code').val().trim();
    if(!code) return alert('Enter code');
    $.ajax({
      url: '/api/cart/apply-discount/',
      method: 'POST', contentType:'application/json',
      headers:{'Authorization':'Bearer '+token},
      data: JSON.stringify({code}),
      success: res=>{ alert(res.detail); loadCart(); },
      error: ()=>alert('Invalid code')
    });
  });

  // checkout
  $('#checkout-btn').click(function(){
    $.ajax({
      url: '/api/cart/checkout/',
      method:'POST',
      headers:{'Authorization':'Bearer '+token},
      success: res=>{ alert(res.detail); loadCart(); },
      error: ()=>alert('Checkout failed')
    });
  });

  $(loadCart);
</script>
</body>
</html>
