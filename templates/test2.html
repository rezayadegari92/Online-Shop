<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ùˆ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</title>
  <style>
    body { font-family: sans-serif; margin: auto; padding: 1rem; max-width: 1000px; direction: rtl; }
    h1, h2 { color: #333; }
    .container { display: flex; gap: 2rem; }
    .products { flex: 2; }
    .cart { flex: 1; border: 1px solid #ccc; padding: 1rem; }
    .product, .item { border: 1px solid #ccc; padding: 0.5rem; margin-bottom: 0.5rem; }
    .actions button, .cart button { padding: 0.4rem 0.8rem; margin-top: 0.3rem; cursor: pointer; }
    input[type='number'] { width: 50px; }
    .price { margin-top: 1rem; font-weight: bold; }
    .checkout-btn { width: 100%; padding: 0.6rem; margin-top: 1rem; background: #28a745; color: #fff; border: none; cursor: pointer; }
    .checkout-btn:hover { background: #218838; }
  </style>
</head>
<body>
  <h1>ğŸ›ï¸ ÙØ±ÙˆØ´Ú¯Ø§Ù‡ Ø¢Ù†Ù„Ø§ÛŒÙ†</h1>
  <div class="container">
    <div class="products">
      <h2>ğŸ“¦ Ù…Ø­ØµÙˆÙ„Ø§Øª</h2>
      <div id="product-list"></div>
    </div>
    <div class="cart">
      <h2>ğŸ›’ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</h2>
      <div id="cart"></div>
      <div class="price" id="cart-total"></div>
      <button class="checkout-btn" onclick="checkout()">Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø³ÙØ§Ø±Ø´</button>
    </div>
  </div>
<script>
  const token = localStorage.getItem('access_token');
  if (!token) {
    document.body.innerHTML = '<h2>Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ ØªÙˆÚ©Ù† JWT Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†ÛŒØ¯.</h2>';
  }

  const apiBase = '/api';

  async function loadProducts() {
    const res = await fetch(`${apiBase}/products/`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!res.ok) { console.error('Error loading products', res.status); return; }
    const data = await res.json();
    renderProducts(data.results);
  }

  function renderProducts(products) {
    const container = document.getElementById('product-list');
    container.innerHTML = '';
    products.forEach(p => {
      const div = document.createElement('div');
      div.className = 'product';
      div.innerHTML = `
        <h3>${p.name}</h3>
        <p>Ù‚ÛŒÙ…Øª: ${p.discounted_price} ØªÙˆÙ…Ø§Ù†</p>
        <div class="actions">
          <button onclick="addToCart(${p.id})">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯</button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  async function addToCart(productId) {
    const res = await fetch(`${apiBase}/cart/items/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ product: productId, quantity: 1 })
    });
    if (res.ok) {
      await loadCart();
    } else {
      const err = await res.json();
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø³Ø¨Ø¯: ' + JSON.stringify(err));
    }
  }

  async function loadCart() {
    const res = await fetch(`${apiBase}/cart/cart/`, {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if (!res.ok) { console.error('Error loading cart', res.status); return; }
    const data = await res.json();
    renderCart(data.items, data.final_price);
  }

  function renderCart(items, total) {
    const container = document.getElementById('cart');
    container.innerHTML = '';
    if (items.length === 0) {
      container.innerHTML = '<p>Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª.</p>';
    } else {
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div><strong>${item.product_name}</strong></div>
          <div>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯: ${item.product_price}</div>
          <div>
            ØªØ¹Ø¯Ø§Ø¯: <input type="number" value="${item.quantity}" min="1" onchange="updateQuantity(${item.id}, this.value)" />
          </div>
          <div class="actions">
            <button onclick="removeItem(${item.id})">Ø­Ø°Ù</button>
          </div>
        `;
        container.appendChild(div);
      });
    }
    document.getElementById('cart-total').innerText = `Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: ${total} ØªÙˆÙ…Ø§Ù†`;
  }

  async function updateQuantity(id, qty) {
    await fetch(`${apiBase}/cart/items/${id}/`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      },
      body: JSON.stringify({ quantity: parseInt(qty) })
    });
    loadCart();
  }

  async function removeItem(id) {
    await fetch(`${apiBase}/cart/items/${id}/`, {
      method: 'DELETE',
      headers: { 'Authorization': 'Bearer ' + token }
    });
    loadCart();
  }

  async function checkout() {
    const res = await fetch(`${apiBase}/cart/checkout/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      }
    });
    const data = await res.json();
    if (res.ok) {
      alert(data.detail || 'Ø³ÙØ§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.');
      loadCart();
    } else {
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´: ' + JSON.stringify(data));
    }
  }

  window.onload = () => {
    loadProducts();
    loadCart();
  };
</script>
</body>
</html>
