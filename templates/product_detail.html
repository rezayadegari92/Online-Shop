<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Product Detail</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style> body { background: #f8f9fa; } .img-thumb{max-width:100px;margin:5px;} </style>
</head>
<body>
<div class="container mt-4">
  <button class="btn btn-link" onclick="history.back()">‚Üê Back</button>
  <div id="product-info"></div>
  <hr>
  <h5>Comments</h5>
  <div id="comments-list"></div>
  <form id="comment-form" class="mb-3">
    <textarea id="comment-content" class="form-control" placeholder="Write a comment..." required></textarea>
    <button class="btn btn-primary mt-2">Post Comment</button>
  </form>
  <h5>Rate this product</h5>
  <form id="rating-form">
    <select id="rating-value" class="form-select w-auto">
      <option value="1">1</option><option value="2">2</option>
      <option value="3">3</option><option value="4">4</option>
      <option value="5">5</option>
    </select>
    <button class="btn btn-success mt-2">Submit Rating</button>
  </form>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
  const token = localStorage.getItem('access_token');
  const pid = new URLSearchParams(location.search).get('id');
  const api = `/api/products/${pid}/`;

  function loadDetail(){
    $.ajax({
      url: api, headers:{'Authorization':'Bearer '+token},
      success: d=>{
        $('#product-info').html(`
          <h2>${d.name}</h2>
          <p>Price: $${d.final_price}</p>
          <p>Category: ${d.category}</p>
          <p>${d.details||''}</p>
          ${d.images.map(i=>`<img src="${i.image_url}" class="img-thumb">`).join('')}
        `);
        renderComments(d.comments);
      },
      error: ()=>alert('Failed to load product')
    });
  }

  function renderComments(list){
    $('#comments-list').empty();
    list.forEach(c=>{
      $('#comments-list').append(`
        <div><strong>${c.author}</strong> <em>${new Date(c.created_at).toLocaleString()}</em>
        <p>${c.content}</p></div>
      `);
    });
  }

  $('#comment-form').submit(e=>{
    e.preventDefault();
    $.ajax({
      url: api, method:'POST', contentType:'application/json',
      headers:{'Authorization':'Bearer '+token},
      data: JSON.stringify({
        action:'comment',
        content: $('#comment-content').val()
      }),
      success: _=>{ $('#comment-content').val(''); loadDetail(); },
      error: ()=>alert('Failed to post comment')
    });
  });

  $('#rating-form').submit(e=>{
    e.preventDefault();
    $.ajax({
      url: api, method:'POST', contentType:'application/json',
      headers:{'Authorization':'Bearer '+token},
      data: JSON.stringify({
        action:'rate',
        value: $('#rating-value').val()
      }),
      success: _=>{ loadDetail(); },
      error: ()=>alert('Failed to submit rating')
    });
  });

  $(loadDetail);
</script>
</body>
</html>
